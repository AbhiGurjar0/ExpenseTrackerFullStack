<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker - Leaderboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .active-filter {
            background-color: #4f46e5;
            color: white;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4f46e5',
                        'primary-dark': '#4338ca',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        info: '#3b82f6',
                        bronze: '#cd7f32',
                        silver: '#c0c0c0',
                        gold: '#ffd700'
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div>
        <%- include('partials/navbar',{user:""}) %>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Page Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Savings Leaderboard</h2>
                <p class="text-gray-600">Compare your financial progress with other users</p>
            </div>
            <div class="mt-4 md:mt-0 flex items-center space-x-3">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" id="search-input" placeholder="Search users..."
                        class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent w-64">
                </div>
                <button id="refresh-btn"
                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition flex items-center">
                    <i class="fas fa-redo-alt mr-2"></i> Refresh
                </button>
            </div>
        </div>



        <!-- Leaderboard Table -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-8">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800">Top Savers Leaderboard</h3>
                <div class="flex items-center space-x-4">


                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Rank</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                User</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Savings Rate</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Yearly Income</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Yearly Expenses</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Savings</th>

                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="leaderboard-body">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="px-6 py-4 border-t border-gray-200 flex flex-col md:flex-row items-center justify-between">
                <div class="text-sm text-gray-700 mb-4 md:mb-0">
                    Showing <span id="pageNumber">1</span> to <span id="totalPages">10</span> of <span
                        id="total_length">127</span> results
                </div>
                <div id="pages" class="flex items-center space-x-2">





                </div>
                <div class="mt-4 md:mt-0 flex items-center space-x-2">
                    <span class="text-sm text-gray-700">Rows per page:</span>
                    <select id="page-size"
                        class="border border-gray-300 rounded-lg px-2 py-1 focus:outline-none focus:ring-1 focus:ring-primary">
                        <option value="1">1</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Your Ranking Card -->
        <div class="bg-gradient-to-r from-primary to-primary-dark text-white rounded-xl shadow-sm p-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <div id="myRank" class="text-3xl font-bold mr-4">#2</div>
                    <div>
                        <h3 class="text-xl font-bold">Your Current Ranking</h3>

                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-center">
                        <div id="mySavingRate" class="text-2xl font-bold">38%</div>
                        <div class="text-primary-100 text-sm">Savings Rate</div>
                    </div>
                    <div class="h-10 w-px bg-white bg-opacity-30"></div>
                    <div class="text-center">
                        <div id="myIncome" class="text-2xl font-bold"></div>
                        <div class="text-primary-100 text-sm">TotalIcome</div>
                    </div>
                    <div class="h-10 w-px bg-white bg-opacity-30"></div>
                    <div class="text-center">
                        <div id="myExpense" class="text-2xl font-bold">12</div>
                        <div class="text-primary-100 text-sm">TotalExpense</div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-12">
        <div class="container mx-auto px-4 py-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-lg font-semibold mb-4">ExpenseTracker</h3>
                    <p class="text-gray-400">Take control of your finances with our intuitive expense tracking app.</p>
                </div>
                <div>
                    <h4 class="text-md font-semibold mb-4">Quick Links</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="#" class="hover:text-white transition">Dashboard</a></li>
                        <li><a href="#" class="hover:text-white transition">Transactions</a></li>
                        <li><a href="#" class="hover:text-white transition">Budgets</a></li>
                        <li><a href="#" class="hover:text-white transition">Reports</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-md font-semibold mb-4">Resources</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="#" class="hover:text-white transition">Help Center</a></li>
                        <li><a href="#" class="hover:text-white transition">Financial Tips</a></li>
                        <li><a href="#" class="hover:text-white transition">Privacy Policy</a></li>
                        <li><a href="#" class="hover:text-white transition">Terms of Service</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-md font-semibold mb-4">Get the App</h4>
                    <div class="flex flex-col space-y-2">
                        <button
                            class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition flex items-center justify-center">
                            <i class="fab fa-apple mr-2"></i> App Store
                        </button>
                        <button
                            class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition flex items-center justify-center">
                            <i class="fab fa-google-play mr-2"></i> Google Play
                        </button>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
                <p>&copy; 2023 ExpenseTracker. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>

        // DOM elements
        const leaderboardBody = document.getElementById('leaderboard-body');
        const paginationNumbers = document.getElementById('pagination-numbers');
        const pageStart = document.getElementById('page-start');
        const pageEnd = document.getElementById('page-end');
        const totalItems = document.getElementById('total-items');
        const searchInput = document.getElementById('search-input');
        const periodFilter = document.getElementById('period-filter');
        const categoryFilter = document.getElementById('category-filter');
        const regionFilter = document.getElementById('region-filter');
        const ageFilter = document.getElementById('age-filter');
        const pageSizeSelect = document.getElementById('page-size');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const firstPageBtn = document.getElementById('first-page');
        const lastPageBtn = document.getElementById('last-page');
        const refreshBtn = document.getElementById('refresh-btn');


        // Initialize the leaderboard
        let currentPage = 1;
        document.addEventListener('DOMContentLoaded', function () {

            const pageLimit = parseInt(document.getElementById('page-size').value) || 1;
            renderLeaderboard([currentPage, pageLimit]);


        });

        // Render leaderboard table
        async function renderLeaderboard(page = [1, pageLimit]) {
            leaderboardBody.innerHTML = '';
            currentPage = page[0];
            pageLimit = page[1];
            console.log(pageLimit)
            let res = await fetch('/leaderboard/data', {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ page }),
            });
            res = await res.json();

            res.users.forEach((user, index) => {
                const globalRank = (res.startRank) + index + 1;
                let savingsRate = 0;
                if (user.totalIncome > 0) {
                    savingsRate = ((user.totalIncome - user.totalExpense) / user.totalIncome) * 100;
                }
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition';
                let rankBadge = '';
                if (globalRank === 1) {
                    rankBadge = `<div class="w-8 h-8 rounded-full bg-gold flex items-center justify-center text-white font-bold">1</div>`;
                } else if (globalRank === 2) {
                    rankBadge = `<div class="w-8 h-8 rounded-full bg-silver flex items-center justify-center text-white font-bold">2</div>`;
                } else if (globalRank === 3) {
                    rankBadge = `<div class="w-8 h-8 rounded-full bg-bronze flex items-center justify-center text-white font-bold">3</div>`;
                } else {
                    rankBadge = `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-700 font-bold">${globalRank}</div>`;
                }


                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                       ${rankBadge}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10 bg-primary rounded-full flex items-center justify-center text-white font-bold">
                              ${user.userName.charAt(0)}
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${user.userName}</div>
                              
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${savingsRate}%</div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-green-600 h-2 rounded-full" style="width:${savingsRate}%"></div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">$${user.totalIncome.toLocaleString()}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">$${user.totalExpense.toLocaleString()}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-success">$${Math.max(user.totalIncome - user.totalExpense, 0)}</div>
                    </td>
                   
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="flex justify-center items-center">
                            <button class="text-primary hover:text-primary-dark" title="View Profile">
                                <i class="fas fa-eye"></i>
                            </button>
                           
                        </div>
                    </td>
                `;

                leaderboardBody.appendChild(row);
                if (res.user.id.id.toString() === user.userId.toString()) {
                    console.log("matchMedia")
                    document.getElementById('myRank').innerHTML = `#${globalRank}`;
                    document.getElementById('myIncome').innerHTML = `$${user.totalIncome}`;
                    document.getElementById('myExpense').innerHTML = `$${user.totalExpense}`;
                    document.getElementById('mySavingRate').innerHTML = `${savingsRate}%`

                }

            });
            let pages = document.getElementById('pages');
            pages.innerHTML = '';
            // console.log(res.count+"1")
            let pageLength = Math.ceil(Number(Number(res?.count) / Number(pageLimit)));
            const prev = document.createElement("button");
            prev.textContent = "Prev";
            prev.disabled = currentPage === 1;
            prev.className = "px-3 py-1 rounded-lg bg-primary-dark text-white hover:bg-primary-dark transition";
            prev.addEventListener("click", () => {
                if (currentPage > 1) renderLeaderboard([currentPage - 1, pageLimit]);
            });
            pages.appendChild(prev);

            for (let i = 0; i < pageLength; i++) {

                const btn = document.createElement("button");
                btn.textContent = i + 1;
                btn.className = "px-3 py-1 rounded-lg bg-primary text-white hover:bg-primary-dark transition";

                btn.addEventListener("click", () => {
                    renderLeaderboard([i + 1, pageLimit]);
                });

                pages.appendChild(btn);

            }
            const next = document.createElement("button");
            next.textContent = "Next";
            next.disabled = currentPage === pageLength;
            next.addEventListener("click", () => {
                if (currentPage < pageLength) renderLeaderboard([currentPage + 1, pageLimit]);
            });
            next.className = "px-3 py-1 rounded-lg bg-primary-dark text-white hover:bg-primary-dark transition";
            pages.appendChild(next);

            //total pages and current page
            document.getElementById('pageNumber').innerText = (res.startRank + 1);
            document.getElementById('totalPages').innerText = (res.startRank + pageLimit);
            document.getElementById('total_length').innerText = Math.ceil(res?.count / pageLimit);

        



        }


        //     // Search functionality
        searchInput.addEventListener('input', () => {
            applyFilters();
        });



        // // Apply all filters
        function applyFilters() {
            const table = document.getElementById('leaderboard-body');
            const rows = table.children;
            console.log(rows)

            // Search filter
            const searchTerm = searchInput.value.toLowerCase();
            Array.from(rows).forEach((row) => {
                const text = row.textContent.toLowerCase().trim();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                }
                else {
                    row.style.display = 'none'

                }
            })


        }


    </script>


</body>

</html>